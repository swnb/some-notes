# CPU 与进程调度

### CPU 上下文

CPU 在运行程序的时候需要设置`CPU 寄存器`和`程序计数器`,这两者统称为 CPU 上下文;

> - CPU 寄存器是 CPU 内置的内存,读些速度极快;
> - 程序计数器是当前程序运行指令的位置;

储存下来的上下文被保存在内核里面, CPU 上下文的切换就是这两者保存和恢复的过程;

根据程序任务的不同,分为

- 进程切换
- 线程切换
- 中断切换

### 用户态和内核态

进程通过调用 syscall 从用户态切换到内核态,两者的区别是用户态受到操作系统的限制,不可以访问受限制的资源;

在 syscall 的过程中,会发成 2 次 CPU 上下文的切换,但这不是进程的上下文切换,这个过程没有进程的切换;

### 进程的调度

对于进程的切换调度,只能由内核完成,这个过程除了 CPU 的上下文的切换,还有虚拟内存和堆栈空间的切换;

### 进程的调度什么时候会发生

首先内核维护了一段队列,排序规则根据进程等待时间和优先级确定,权重高的先运行;

可以调度下一个进程的几种情况:

- 某个进程 CPU 时间片用完了;
- 系统的资源不足,暂时挂起进程;
- 进程主动的请求刮起,比如 sleep;
- 硬件中断信号发出;

### 线程的调度

内核调度的是线程,进程给线程提供给虚拟内存和寄存器,如果在线程切换是同一进程,只有少量的上下文切换,如果不是同一进程,那么等同于进程切换;

### 中断调度

中断引起的切换只发生在内核态,用户态不需要切换,而且内核态的切换都是很短的,但是大量的切换会严重的消耗计算机的资源;

### 调度

要实现调度,那么就有关唤醒,这个时候必须是条件变量这种神器来实现
